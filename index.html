<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Closure tree by mceachen</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Closure tree</h1>
        <p>Easily and efficiently make your ActiveRecord model support hierarchies</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/mceachen/closure_tree" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/mceachen/closure_tree/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/mceachen/closure_tree/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a name="closure-tree" class="anchor" href="#closure-tree"><span class="octicon octicon-link"></span></a>Closure Tree</h1>

<h3>
<a name="closure_tree-lets-your-activerecord-models-act-as-nodes-in-a-tree-data-structure" class="anchor" href="#closure_tree-lets-your-activerecord-models-act-as-nodes-in-a-tree-data-structure"><span class="octicon octicon-link"></span></a>Closure_tree lets your ActiveRecord models act as nodes in a <a href="http://en.wikipedia.org/wiki/Tree_%28data_structure%29">tree data structure</a>
</h3>

<p>Common applications include modeling hierarchical data, like tags, page graphs in CMSes,
and tracking user referrals.</p>

<p><a href="http://travis-ci.org/mceachen/closure_tree"><img src="https://secure.travis-ci.org/mceachen/closure_tree.png?branch=master" alt="Build Status"></a>
<a href="http://rubygems.org/gems/closure_tree"><img src="https://badge.fury.io/rb/closure_tree.png" alt="Gem Version"></a>
<a href="https://codeclimate.com/github/mceachen/closure_tree"><img src="https://codeclimate.com/github/mceachen/closure_tree.png" alt="Code Climate"></a></p>

<p>Substantially more efficient than
<a href="https://github.com/stefankroes/ancestry">ancestry</a> and
<a href="https://github.com/amerine/acts_as_tree">acts_as_tree</a>, and even more
awesome than <a href="https://github.com/collectiveidea/awesome_nested_set/">awesome_nested_set</a>,
closure_tree has some great features:</p>

<ul>
<li>
<strong>Best-in-class select performance</strong>:

<ul>
<li>Fetch your whole ancestor lineage in 1 SELECT.</li>
<li>Grab all your descendants in 1 SELECT.</li>
<li>Get all your siblings in 1 SELECT.</li>
<li>Fetch all <a href="#nested-hashes">descendants as a nested hash</a> in 1 SELECT.</li>
<li>
<a href="#find_or_create_by_path">Find a node by ancestry path</a> in 1 SELECT.</li>
</ul>
</li>
<li>
<strong>Best-in-class mutation performance</strong>:

<ul>
<li>2 SQL INSERTs on node creation</li>
<li>3 SQL INSERT/UPDATEs on node reparenting</li>
</ul>
</li>
<li><strong>Support for Rails 3.0, 3.1, 3.2, and 4.0</strong></li>
<li>Support for reparenting children (and all their progeny)</li>
<li>Support for <a href="#concurrency">concurrency</a> (using <a href="https://github/mceachen/with_advisory_lock">with_advisory_lock</a>)</li>
<li>Support for polymorphism <a href="#sti">STI</a> within the hierarchy</li>
<li>
<code>find_or_create_by_path</code> for <a href="#find_or_create_by_path">building out hierarchies quickly and conveniently</a>
</li>
<li>Support for <a href="#deterministic-ordering">deterministic ordering</a> of children</li>
<li>Support for <a href="http://en.wikipedia.org/wiki/Tree_traversal#Pre-order">preordered</a> traversal of descendants</li>
<li>Support for rendering trees in <a href="http://en.wikipedia.org/wiki/DOT_(graph_description_language">DOT format</a>), using <a href="http://www.graphviz.org/">Graphviz</a>
</li>
<li>Excellent <a href="#testing">test coverage</a> in a variety of environments</li>
</ul><p>See <a href="http://karwin.blogspot.com/">Bill Karwin</a>'s excellent
<a href="http://www.slideshare.net/billkarwin/models-for-hierarchical-data">Models for hierarchical data presentation</a>
for a description of different tree storage algorithms.</p>

<h2>
<a name="table-of-contents" class="anchor" href="#table-of-contents"><span class="octicon octicon-link"></span></a>Table of Contents</h2>

<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#accessing-data">Accessing Data</a></li>
<li><a href="#polymorphic-hierarchies-with-sti">Polymorphic hierarchies with STI</a></li>
<li><a href="#deterministic-ordering">Deterministic ordering</a></li>
<li><a href="#concurrency">Concurrency</a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#change-log">Change log</a></li>
</ul><h2>
<a name="installation" class="anchor" href="#installation"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Note that closure_tree only supports Rails 3.0 and later, and has test coverage for MySQL, PostgreSQL, and SQLite.</p>

<ol>
<li><p>Add this to your Gemfile: <code>gem 'closure_tree'</code></p></li>
<li><p>Run <code>bundle install</code></p></li>
<li><p>Add <code>acts_as_tree</code> to your hierarchical model(s). There are a number of <a href="#available-options">options</a> you can pass in, too.</p></li>
<li>
<p>Add a migration to add a <code>parent_id</code> column to the model you want to act_as_tree.
You may want to also <a href="#sort_order">add a column for deterministic ordering of children</a>, but that's optional.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">AddParentIdToTag</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:tag</span><span class="p">,</span> <span class="ss">:parent_id</span><span class="p">,</span> <span class="ss">:integer</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Note that if the column is null, the tag will be considered a root node.</p>
</li>
<li>
<p>Add a database migration to store the hierarchy for your model. By
default the table name will be the model's table name, followed by
"_hierarchies". Note that by calling <code>acts_as_tree</code>, a "virtual model" (in this case, <code>TagHierarchy</code>)
will be added automatically, so you don't need to create it.</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateTagHierarchies</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:tag_hierarchies</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span>  <span class="ss">:ancestor_id</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>   <span class="c1"># ID of the parent/grandparent/great-grandparent/... tag</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span>  <span class="ss">:descendant_id</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="c1"># ID of the target tag</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span>  <span class="ss">:generations</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>   <span class="c1"># Number of generations between the ancestor and the descendant. Parent/child = 1, for example.</span>
    <span class="k">end</span>

    <span class="c1"># For "all progeny of…" selects:</span>
    <span class="n">add_index</span> <span class="ss">:tag_hierarchies</span><span class="p">,</span> <span class="o">[</span><span class="ss">:ancestor_id</span><span class="p">,</span> <span class="ss">:descendant_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>

    <span class="c1"># For "all ancestors of…" selects</span>
    <span class="n">add_index</span> <span class="ss">:tag_hierarchies</span><span class="p">,</span> <span class="o">[</span><span class="ss">:descendant_id</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</li>
<li><p>Run <code>rake db:migrate</code></p></li>
<li>
<p>If you're migrating from another system where your model already has a
<code>parent_id</code> column, run <code>Tag.rebuild!</code> and your
<code>tag_hierarchies</code> table will be truncated and rebuilt.</p>

<p>If you're starting from scratch you don't need to call <code>rebuild!</code>.</p>
</li>
</ol><h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<h3>
<a name="creation" class="anchor" href="#creation"><span class="octicon octicon-link"></span></a>Creation</h3>

<p>Create a root node:</p>

<div class="highlight"><pre><span class="n">grandparent</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Grandparent'</span><span class="p">)</span>
</pre></div>

<p>Child nodes are created by appending to the children collection:</p>

<div class="highlight"><pre><span class="n">parent</span> <span class="o">=</span> <span class="n">grandparent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Parent'</span><span class="p">)</span>
</pre></div>

<p>Or by appending to the children collection:</p>

<div class="highlight"><pre><span class="n">child2</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Second Child'</span><span class="p">)</span>
<span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">&lt;&lt;</span> <span class="n">child2</span>
</pre></div>

<p>Or by calling the "add_child" method:</p>

<div class="highlight"><pre><span class="n">child3</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Third Child'</span><span class="p">)</span>
<span class="n">parent</span><span class="o">.</span><span class="n">add_child</span> <span class="n">child3</span>
</pre></div>

<p>Then:</p>

<div class="highlight"><pre><span class="n">grandparent</span><span class="o">.</span><span class="n">self_and_descendants</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Grandparent"</span><span class="p">,</span> <span class="s2">"Parent"</span><span class="p">,</span> <span class="s2">"First Child"</span><span class="p">,</span> <span class="s2">"Second Child"</span><span class="p">,</span> <span class="s2">"Third Child"</span><span class="o">]</span>

<span class="n">child1</span><span class="o">.</span><span class="n">ancestry_path</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"Grandparent"</span><span class="p">,</span> <span class="s2">"Parent"</span><span class="p">,</span> <span class="s2">"First Child"</span><span class="o">]</span>
</pre></div>

<h3>
<a name="find_or_create_by_path" class="anchor" href="#find_or_create_by_path"><span class="octicon octicon-link"></span></a>find_or_create_by_path</h3>

<p>We can do all the node creation and add_child calls with one method call:</p>

<div class="highlight"><pre><span class="n">child</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_path</span><span class="p">(</span><span class="o">[</span><span class="s2">"grandparent"</span><span class="p">,</span> <span class="s2">"parent"</span><span class="p">,</span> <span class="s2">"child"</span><span class="o">]</span><span class="p">)</span>
</pre></div>

<p>You can <code>find</code> as well as <code>find_or_create</code> by "ancestry paths".
Ancestry paths may be built using any column in your model. The default
column is <code>name</code>, which can be changed with the :name_column option
provided to <code>acts_as_tree</code>.</p>

<p>Note that any other AR fields can be set with the second, optional <code>attributes</code> argument,
and as of version 4.2.0, these attributes are added to the where clause as selection criteria.</p>

<div class="highlight"><pre><span class="n">child</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_path</span><span class="p">(</span><span class="sx">%w{home chuck Photos"}</span><span class="p">,</span> <span class="p">{</span><span class="ss">:tag_type</span> <span class="o">=&gt;</span> <span class="s2">"File"</span><span class="p">})</span>
</pre></div>

<p>This will pass the attribute hash of <code>{:name =&gt; "home", :tag_type =&gt; "File"}</code> to
<code>Tag.find_or_create_by_name</code> if the root directory doesn't exist (and
<code>{:name =&gt; "chuck", :tag_type =&gt; "File"}</code> if the second-level tag doesn't exist, and so on).</p>

<h3>
<a name="moving-nodes-around-the-tree" class="anchor" href="#moving-nodes-around-the-tree"><span class="octicon octicon-link"></span></a>Moving nodes around the tree</h3>

<p>Nodes can be moved around to other parents, and closure_tree moves the node's descendancy to the new parent for you:</p>

<div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_path</span> <span class="sx">%w(a b c d)</span>
<span class="n">h</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_path</span> <span class="sx">%w(e f g h)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">root</span>
<span class="n">d</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># "d.children &lt;&lt; e" would work too, of course</span>
<span class="n">h</span><span class="o">.</span><span class="n">ancestry_path</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">,</span> <span class="s2">"d"</span><span class="p">,</span> <span class="s2">"e"</span><span class="p">,</span> <span class="s2">"f"</span><span class="p">,</span> <span class="s2">"g"</span><span class="p">,</span> <span class="s2">"h"</span><span class="o">]</span>
</pre></div>

<h3>
<a name="nested-hashes" class="anchor" href="#nested-hashes"><span class="octicon octicon-link"></span></a>Nested hashes</h3>

<p><code>hash_tree</code> provides a method for rendering a subtree as an
ordered nested hash:</p>

<div class="highlight"><pre><span class="n">b</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_path</span> <span class="sx">%w(a b)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">parent</span>
<span class="n">b2</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">find_or_create_by_path</span> <span class="sx">%w(a b2)</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">find_or_create_by_path</span> <span class="sx">%w(c1 d1)</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">parent</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">find_or_create_by_path</span> <span class="sx">%w(c2 d2)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">parent</span>

<span class="no">Tag</span><span class="o">.</span><span class="n">hash_tree</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="n">a</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">b</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">c1</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">d1</span> <span class="o">=&gt;</span> <span class="p">{}},</span> <span class="n">c2</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">d2</span> <span class="o">=&gt;</span> <span class="p">{}}},</span> <span class="n">b2</span> <span class="o">=&gt;</span> <span class="p">{}}}</span>

<span class="no">Tag</span><span class="o">.</span><span class="n">hash_tree</span><span class="p">(</span><span class="ss">:limit_depth</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="n">a</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">b</span> <span class="o">=&gt;</span> <span class="p">{},</span> <span class="n">b2</span> <span class="o">=&gt;</span> <span class="p">{}}}</span>

<span class="n">b</span><span class="o">.</span><span class="n">hash_tree</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="n">b</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">c1</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">d1</span> <span class="o">=&gt;</span> <span class="p">{}},</span> <span class="n">c2</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">d2</span> <span class="o">=&gt;</span> <span class="p">{}}}}</span>

<span class="n">b</span><span class="o">.</span><span class="n">hash_tree</span><span class="p">(</span><span class="ss">:limit_depth</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="p">{</span><span class="n">b</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="n">c1</span> <span class="o">=&gt;</span> <span class="p">{},</span> <span class="n">c2</span> <span class="o">=&gt;</span> <span class="p">{}}}</span>
</pre></div>

<p><strong>If your tree is large (or might become so), use :limit_depth.</strong></p>

<p>Without this option, <code>hash_tree</code> will load the entire contents of that table into RAM. Your
server may not be happy trying to do this.</p>

<p>HT: <a href="https://github.com/stefankroes/ancestry#arrangement">ancestry</a> and <a href="https://github.com/mceachen/closure_tree/issues/11">elhoyos</a></p>

<h3>
<a name="graph-visualization" class="anchor" href="#graph-visualization"><span class="octicon octicon-link"></span></a>Graph visualization</h3>

<p><code>to_dot_digraph</code> is suitable for passing into <a href="http://www.graphviz.org/">Graphviz</a>.</p>

<p>For example, for the above tree, write out the DOT file with ruby:</p>

<div class="highlight"><pre><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"example.dot"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="no">Tag</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">to_dot_digraph</span><span class="p">)</span> <span class="p">}</span>
</pre></div>

<p>Then, in a shell, <code>dot -Tpng example.dot &gt; example.png</code>, which produces:</p>

<p><img src="https://raw.github.com/mceachen/closure_tree/master/img/example.png" alt="Example tree"></p>

<p>If you want to customize the label value, override the <code>#to_digraph_label</code> instance method in your model.</p>

<p>Just for kicks, this is the test tree I used for proving that preordered tree traversal was correct:</p>

<p><img src="https://raw.github.com/mceachen/closure_tree/master/img/preorder.png" alt="Preordered test tree"></p>

<h3>
<a name="available-options" class="anchor" href="#available-options"><span class="octicon octicon-link"></span></a>Available options</h3>

<p>When you include <code>acts_as_tree</code> in your model, you can provide a hash to override the following defaults:</p>

<ul>
<li>
<code>:parent_column_name</code> to override the column name of the parent foreign key in the model's table. This defaults to "parent_id".</li>
<li>
<code>:hierarchy_table_name</code> to override the hierarchy class name. This defaults to the singular name of the model + "Hierarchy", like <code>TagHierarchy</code>.</li>
<li>
<code>:hierarchy_table_name</code> to override the hierarchy table name. This defaults to the singular name of the model + "_hierarchies", like <code>tag_hierarchies</code>.</li>
<li>
<code>:dependent</code> determines what happens when a node is destroyed. Defaults to <code>nullify</code>.

<ul>
<li>
<code>:nullify</code> will simply set the parent column to null. Each child node will be considered a "root" node. This is the default.</li>
<li>
<code>:delete_all</code> will delete all descendant nodes (which circumvents the destroy hooks)</li>
<li>
<code>:destroy</code> will destroy all descendant nodes (which runs the destroy hooks on each child node)</li>
</ul>
</li>
<li>
<code>:name_column</code> used by #<code>find_or_create_by_path</code>, #<code>find_by_path</code>, and <code>ancestry_path</code> instance methods. This is primarily useful if the model only has one required field (like a "tag").</li>
<li>
<code>:order</code> used to set up <a href="#deterministic-ordering">deterministic ordering</a>
</li>
</ul><h2>
<a name="accessing-data" class="anchor" href="#accessing-data"><span class="octicon octicon-link"></span></a>Accessing Data</h2>

<h3>
<a name="class-methods" class="anchor" href="#class-methods"><span class="octicon octicon-link"></span></a>Class methods</h3>

<ul>
<li>
<code>Tag.root</code> returns an arbitrary root node</li>
<li>
<code>Tag.roots</code> returns all root nodes</li>
<li>
<code>Tag.leaves</code> returns all leaf nodes</li>
<li>
<code>Tag.hash_tree</code> returns an <a href="#nested-hashes">ordered, nested hash</a> that can be depth-limited.</li>
<li>
<code>Tag.find_by_path(path, attributes)</code> returns the node whose name path is <code>path</code>. See (#find_or_create_by_path).</li>
<li>
<code>Tag.find_or_create_by_path(path, attributes)</code> returns the node whose name path is <code>path</code>, and will create the node if it doesn't exist already.See (#find_or_create_by_path).</li>
<li>
<code>Tag.find_all_by_generation(generation_level)</code> returns the descendant nodes who are <code>generation_level</code> away from a root. <code>Tag.find_all_by_generation(0)</code> is equivalent to <code>Tag.roots</code>.</li>
<li>
<code>Tag.with_ancestor(ancestors)</code> scopes to all descendants whose ancestor is in the given list.</li>
</ul><h3>
<a name="instance-methods" class="anchor" href="#instance-methods"><span class="octicon octicon-link"></span></a>Instance methods</h3>

<ul>
<li>
<code>tag.root</code> returns the root for this node</li>
<li>
<code>tag.root?</code> returns true if this is a root node</li>
<li>
<code>tag.child?</code> returns true if this is a child node. It has a parent.</li>
<li>
<code>tag.leaf?</code> returns true if this is a leaf node. It has no children.</li>
<li>
<code>tag.leaves</code> is scoped to all leaf nodes in self_and_descendants.</li>
<li>
<code>tag.depth</code> returns the depth, or "generation", for this node in the tree. A root node will have a value of 0.</li>
<li>
<code>tag.parent</code> returns the node's immediate parent. Root nodes will return nil.</li>
<li>
<code>tag.children</code> is a <code>has_many</code> of immediate children (just those nodes whose parent is the current node).</li>
<li>
<code>tag.child_ids</code> is an array of the IDs of the children.</li>
<li>
<code>tag.ancestors</code> is a ordered scope of [ parent, grandparent, great grandparent, … ]. Note that the size of this array will always equal <code>tag.depth</code>.</li>
<li>
<code>tag.ancestor_ids</code> is an array of the IDs of the ancestors.</li>
<li>
<code>tag.self_and_ancestors</code> returns a scope containing self, parent, grandparent, great grandparent, etc.</li>
<li>
<code>tag.siblings</code> returns a scope containing all nodes with the same parent as <code>tag</code>, excluding self.</li>
<li>
<code>tag.sibling_ids</code> returns an array of the IDs of the siblings.</li>
<li>
<code>tag.self_and_siblings</code> returns a scope containing all nodes with the same parent as <code>tag</code>, including self.</li>
<li>
<code>tag.descendants</code> returns a scope of all children, childrens' children, etc., excluding self ordered by depth.</li>
<li>
<code>tag.descendant_ids</code> returns an array of the IDs of the descendants.</li>
<li>
<code>tag.self_and_descendants</code> returns a scope of all children, childrens' children, etc., including self, ordered by depth.</li>
<li>
<code>tag.hash_tree</code> returns an <a href="#nested-hashes">ordered, nested hash</a> that can be depth-limited.</li>
<li>
<code>tag.find_by_path(path)</code> returns the node whose name path <em>from <code>tag</code></em> is <code>path</code>. See (#find_or_create_by_path).</li>
<li>
<code>tag.find_or_create_by_path(path)</code> returns the node whose name path <em>from <code>tag</code></em> is <code>path</code>, and will create the node if it doesn't exist already.See (#find_or_create_by_path).</li>
<li>
<code>tag.find_all_by_generation(generation_level)</code> returns the descendant nodes who are <code>generation_level</code> away from <code>tag</code>.

<ul>
<li>
<code>tag.find_all_by_generation(0).to_a</code> == <code>[tag]</code>
</li>
<li>
<code>tag.find_all_by_generation(1)</code> == <code>tag.children</code>
</li>
<li>
<code>tag.find_all_by_generation(2)</code> will return the tag's grandchildren, and so on.</li>
</ul>
</li>
<li>
<code>tag.destroy</code> will destroy a node and do <em>something</em> to its children, which is determined by the <code>:dependent</code> option passed to <code>acts_as_tree</code>.</li>
</ul><h2>
<a name="polymorphic-hierarchies-with-sti" class="anchor" href="#polymorphic-hierarchies-with-sti"><span class="octicon octicon-link"></span></a>Polymorphic hierarchies with STI</h2>

<p>Polymorphic models using single table inheritance (STI) are supported:</p>

<ol>
<li>Create a db migration that adds a String <code>type</code> column to your model</li>
<li>Subclass the model class. You only need to add <code>acts_as_tree</code> to your base class:</li>
</ol><div class="highlight"><pre><span class="k">class</span> <span class="nc">Tag</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">acts_as_tree</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">WhenTag</span> <span class="o">&lt;</span> <span class="no">Tag</span> <span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">WhereTag</span> <span class="o">&lt;</span> <span class="no">Tag</span> <span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">WhatTag</span> <span class="o">&lt;</span> <span class="no">Tag</span> <span class="p">;</span> <span class="k">end</span>
</pre></div>

<p>Please note that Rails (&lt;= 3.2) doesn't handle polymorphic associations correctly if
you use the <code>:type</code> attribute, so <strong>this doesn't work</strong>:</p>

<div class="highlight"><pre><span class="c1"># BAD: ActiveRecord ignores the :type attribute:</span>
<span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"child"</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">"WhenTag"</span><span class="p">)</span>
</pre></div>

<p>Instead, use either <code>.add_child</code> or <code>children &lt;&lt;</code>:</p>

<div class="highlight"><pre><span class="c1"># GOOD!</span>
<span class="n">a</span> <span class="o">=</span> <span class="no">Tag</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"a"</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="no">WhenTag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"b"</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">children</span> <span class="o">&lt;&lt;</span> <span class="n">b</span>
<span class="n">c</span> <span class="o">=</span> <span class="no">WhatTag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"c"</span><span class="p">)</span>
<span class="n">b</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>

<p>See <a href="https://github.com/mceachen/closure_tree/issues/43">issue 43</a> for more information.</p>

<h2>
<a name="deterministic-ordering" class="anchor" href="#deterministic-ordering"><span class="octicon octicon-link"></span></a>Deterministic ordering</h2>

<p>By default, children will be ordered by your database engine, which may not be what you want.</p>

<p>If you want to order children alphabetically, and your model has a <code>name</code> column, you'd do this:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Tag</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">acts_as_tree</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">'name'</span>
<span class="k">end</span>
</pre></div>

<p>If you want a specific order, add a new integer column to your model in a migration:</p>

<div class="highlight"><pre><span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:sort_order</span>
</pre></div>

<p>and in your model:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">OrderedTag</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
  <span class="n">acts_as_tree</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">'sort_order'</span>
<span class="k">end</span>
</pre></div>

<p>When you enable <code>order</code>, you'll also have the following new methods injected into your model:</p>

<ul>
<li>
<code>tag.siblings_before</code> is a scope containing all nodes with the same parent as <code>tag</code>,
whose sort order column is less than <code>self</code>. These will be ordered properly, so the <code>last</code>
element in scope will be the sibling immediately before <code>self</code>
</li>
<li>
<code>tag.siblings_after</code> is a scope containing all nodes with the same parent as <code>tag</code>,
whose sort order column is more than <code>self</code>. These will be ordered properly, so the <code>first</code>
element in scope will be the sibling immediately "after" <code>self</code>
</li>
</ul><p>If your <code>order</code> column is an integer attribute, you'll also have these:</p>

<ul>
<li><p>The class method <code>#roots_and_descendants_preordered</code>, which returns all nodes in your tree,
<a href="http://en.wikipedia.org/wiki/Tree_traversal#Pre-order">pre-ordered</a>.</p></li>
<li><p><code>node1.self_and_descendants_preordered</code> which will return descendants,
<a href="http://en.wikipedia.org/wiki/Tree_traversal#Pre-order">pre-ordered</a>.</p></li>
<li>
<p><code>node1.prepend_sibling(node2)</code> which will</p>

<ol>
<li>set <code>node2</code> to the same parent as <code>node1</code>,</li>
<li>set <code>node2</code>'s order column to 1 less than <code>node1</code>'s value, and</li>
<li>decrement the order_column of all children of node1's parents whose order_column is &lt;&gt;&gt;= node2's new value by 1.</li>
</ol>
</li>
<li>
<p><code>node1.append_sibling(node2)</code> which will</p>

<ol>
<li>set <code>node2</code> to the same parent as <code>node1</code>,</li>
<li>set <code>node2</code>'s order column to 1 more than <code>node1</code>'s value, and</li>
<li>increment the order_column of all children of node1's parents whose order_column is &gt;= node2's new value by 1.</li>
</ol>
</li>
</ul><div class="highlight"><pre>
<span class="n">root</span> <span class="o">=</span> <span class="no">OrderedTag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"root"</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="no">OrderedTag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"a"</span><span class="p">,</span> <span class="ss">:parent</span> <span class="o">=&gt;</span> <span class="s2">"root"</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="no">OrderedTag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"b"</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="no">OrderedTag</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"c"</span><span class="p">)</span>

<span class="c1"># We have to call 'root.reload.children' because root won't be in sync with the database otherwise:</span>

<span class="n">a</span><span class="o">.</span><span class="n">append_sibling</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="o">]</span>

<span class="n">a</span><span class="o">.</span><span class="n">prepend_sibling</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"a"</span><span class="o">]</span>

<span class="n">a</span><span class="o">.</span><span class="n">append_sibling</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">,</span> <span class="s2">"c"</span><span class="o">]</span>

<span class="n">b</span><span class="o">.</span><span class="n">append_sibling</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">root</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"b"</span><span class="p">,</span> <span class="s2">"c"</span><span class="p">,</span> <span class="s2">"a"</span><span class="o">]</span>
</pre></div>

<h2>
<a name="concurrency" class="anchor" href="#concurrency"><span class="octicon octicon-link"></span></a>Concurrency</h2>

<p>Several methods, especially <code>#rebuild</code> and <code>#find_or_create_by_path</code>, cannot run concurrently correctly.
<code>#find_or_create_by_path</code>, for example, may create duplicate nodes.</p>

<p>Database row-level locks work correctly with PostgreSQL, but MySQL's row-level locking is broken, and
erroneously reports deadlocks where there are none. To work around this, and have a consistent implementation
for both MySQL and PostgreSQL, <a href="https://github.com/mceachen/with_advisory_lock">with_advisory_lock</a>
is used automatically to ensure correctness.</p>

<p>If you are already managing concurrency elsewhere in your application, and want to disable the use
of with_advisory_lock, pass <code>:with_advisory_lock =&gt; false</code> in the options hash:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Tag</span>
  <span class="n">acts_as_tree</span> <span class="ss">:with_advisory_lock</span> <span class="o">=&gt;</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></div>

<p>Note that you <em>will eventually have data corruption</em> if you disable advisory locks, write to your
database with multiple threads, and don't provide an alternative mutex.</p>

<h2>
<a name="faq" class="anchor" href="#faq"><span class="octicon octicon-link"></span></a>FAQ</h2>

<h3>
<a name="does-this-gem-support-multiple-parents" class="anchor" href="#does-this-gem-support-multiple-parents"><span class="octicon octicon-link"></span></a>Does this gem support multiple parents?</h3>

<p>No. This gem's API is based on the assumption that each node has either 0 or 1 parent.</p>

<p>The underlying closure tree structure will support multiple parents, but there would be many
breaking-API changes to support it. I'm open to suggestions and pull requests.</p>

<h3>
<a name="how-do-i-use-this-with-test-fixtures" class="anchor" href="#how-do-i-use-this-with-test-fixtures"><span class="octicon octicon-link"></span></a>How do I use this with test fixtures?</h3>

<p>Test fixtures aren't going to be running your <code>after_save</code> hooks after inserting all your
fixture data, so you need to call <code>.rebuild!</code> before your test runs. There's an example in
the spec <code>tag_spec.rb</code>:</p>

<div class="highlight"><pre>  <span class="n">describe</span> <span class="s2">"Tag with fixtures"</span> <span class="k">do</span>
    <span class="n">fixtures</span> <span class="ss">:tags</span>
    <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
      <span class="no">Tag</span><span class="o">.</span><span class="n">rebuild!</span> <span class="c1"># &lt;- required if you use fixtures</span>
    <span class="k">end</span>
</pre></div>

<p><strong>However, if you're just starting with Rails, may I humbly suggest you adopt a factory library</strong>,
rather than using fixtures? <a href="https://www.google.com/search?q=fixtures+versus+factories">Lots of people have written about this already</a>.</p>

<h3>
<a name="there-are-many-lock--files-in-my-project-directory-after-test-runs" class="anchor" href="#there-are-many-lock--files-in-my-project-directory-after-test-runs"><span class="octicon octicon-link"></span></a>There are many <code>lock-*</code> files in my project directory after test runs</h3>

<p>This is expected if you aren't using MySQL or Postgresql for your tests.</p>

<p>SQLite doesn't have advisory locks, so we resort to file locking, which will only work
if the <code>FLOCK_DIR</code> is set consistently for all ruby processes.</p>

<p>In your <code>spec_helper.rb</code> or <code>minitest_helper.rb</code>, add a <code>before</code> and <code>after</code> block:</p>

<div class="highlight"><pre><span class="n">before</span> <span class="k">do</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s1">'FLOCK_DIR'</span><span class="o">]</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">mktmpdir</span>
<span class="k">end</span>

<span class="n">after</span> <span class="k">do</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">remove_entry_secure</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'FLOCK_DIR'</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>

<h2>
<a name="testing" class="anchor" href="#testing"><span class="octicon octicon-link"></span></a>Testing</h2>

<p>Closure tree is <a href="http://travis-ci.org/#!/mceachen/closure_tree">tested under every valid combination</a> of</p>

<ul>
<li>Ruby 1.9.3 and Ruby 2.0.0</li>
<li>The latest Rails 3.0, 3.1, 3.2, and 4.0 branches, and</li>
<li>MySQL and PostgreSQL. SQLite works in a single-threaded environment.</li>
</ul><p>Assuming you're using <a href="https://github.com/sstephenson/rbenv">rbenv</a>, you can use <code>tests.sh</code> to
run the test matrix locally.</p>

<p>Parallelism is not tested with Rails 3.0.x nor 3.1.x due to this
<a href="https://github.com/rails/rails/issues/7538">known issue</a>.</p>

<h2>
<a name="change-log" class="anchor" href="#change-log"><span class="octicon octicon-link"></span></a>Change log</h2>

<p>See <a href="https://github.com/mceachen/closure_tree/blob/master/CHANGELOG.md">https://github.com/mceachen/closure_tree/blob/master/CHANGELOG.md</a></p>

<h2>
<a name="thanks-to" class="anchor" href="#thanks-to"><span class="octicon octicon-link"></span></a>Thanks to</h2>

<ul>
<li><a href="https://github.com/collectiveidea/awesome_nested_set">https://github.com/collectiveidea/awesome_nested_set</a></li>
<li><a href="https://github.com/patshaughnessy/class_factory">https://github.com/patshaughnessy/class_factory</a></li>
<li>JetBrains, which provides an <a href="http://www.jetbrains.com/ruby/buy/buy.jsp#openSource">open-source license</a> to
<a href="http://www.jetbrains.com/ruby/features/">RubyMine</a> for the development of this project.</li>
</ul>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/mceachen">mceachen</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-38750440-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>